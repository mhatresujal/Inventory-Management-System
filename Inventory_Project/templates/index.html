<!DOCTYPE html>
<html>
<head>
  <title>Inventory Tracker</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .low-stock { background-color: #f8d7da !important; }
    .tile {
      padding: 20px; background: #007bff; color: white; border-radius: 10px;
      text-align: center; margin: 10px;
    }
    .tile h4 { font-size: 20px; margin-bottom: 5px; }
  </style>
</head>
<body class="container mt-4">
  <h1 class="text-center mb-4">ðŸ“¦ Inventory Tracker</h1>

  <!-- Dashboard Tiles -->
  <div class="row mb-4">
    <div class="col-md-3 tile">
      <h4>Total Products</h4>
      <p>{{ products|length }}</p>
    </div>
    <div class="col-md-3 tile" style="background: #28a745;">
      <h4>Low Stock Items</h4>
      <p>{{ products|selectattr('quantity', 'lt', 5)|list|length }}</p>
    </div>
    <div class="col-md-3 tile" style="background: #6f42c1;">
      <h4>Total Inventory Value</h4>
      <p>â‚¹ {{ "{:,.2f}".format(total_value) }}</p>
    </div>
  </div>

  <!-- Add New Product -->
  <div class="card p-3 mb-4">
    <h3 class="mb-3">Add New Product</h3>
    <form class="row g-2" method="POST" action="{{ url_for('add_product') }}">
      <div class="col-md-4">
        <input type="text" name="product_name" class="form-control" placeholder="Product Name" required>
      </div>
      <div class="col-md-3">
        <input type="number" name="quantity" class="form-control" placeholder="Quantity" min="0" required>
      </div>
      <div class="col-md-3">
        <input type="number" step="0.01" name="rate" class="form-control" placeholder="Rate per Unit" min="0" required>
      </div>
      <div class="col-md-2 d-grid">
        <button class="btn btn-primary" type="submit">Add</button>
      </div>
    </form>
  </div>

  <!-- Create Purchase Order -->
  <div class="card p-3 mb-4">
    <h3 class="mb-3">Create Purchase Order</h3>
    <form class="row g-2" method="POST" action="{{ url_for('create_po') }}">
      <div class="col-md-4">
        <!-- product_id expected by /create_po -->
        <select name="product_id" class="form-control" required>
          <option value="">Select Product</option>
          {% for p in products %}
            <option value="{{ p['id'] }}">{{ p['product_name'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <!-- quantity expected by /create_po -->
        <input type="number" name="quantity" class="form-control" placeholder="Quantity" min="1" required>
      </div>
      <div class="col-md-3">
        <!-- vendor_id expected by /create_po -->
        <select name="vendor_id" class="form-control" required>
          <option value="">Select Vendor</option>
          {% for v in vendors %}
            <option value="{{ v['id'] }}">{{ v['vendor_name'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 d-grid">
        <button class="btn btn-success" type="submit">Create PO</button>
      </div>
    </form>
  </div>

  <!-- Links -->
  <div class="mb-3">
    <a href="{{ url_for('po_history') }}" class="btn btn-secondary">View PO History</a>
    <a href="{{ url_for('vendor_page') }}" class="btn btn-dark">Manage Vendors</a>
    <a href="{{ url_for('export_csv') }}" class="btn btn-warning">Export Inventory to CSV</a>
  </div>

  <!-- Inventory Table -->
  <h3>Current Inventory</h3>
  <table class="table table-bordered table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th style="width: 80px;">ID</th>
        <th>Product</th>
        <th style="width: 120px;">Quantity</th>
        <th style="width: 120px;">Rate (â‚¹)</th>
        <th style="width: 160px;">Total (â‚¹)</th>
        <th style="width: 280px;">Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for product in products %}
      <tr class="{% if product.quantity|int < 5 %}low-stock{% endif %}">
        <td>{{ product.id }}</td>
        <td>{{ product.product_name }}</td>
        <td>{{ product.quantity }}</td>
        <td>{{ "{:,.2f}".format(product.price) }}</td>
        <td>{{ "{:,.2f}".format(product.quantity * product.price) }}</td>
        <td>
          <!-- Update quantity: app.py expects a final absolute 'quantity' -->
          <form method="POST"
                action="{{ url_for('update_quantity', product_id=product.id) }}"
                class="d-inline-flex gap-2">
            <input type="number" name="quantity" class="form-control" placeholder="New Qty" min="0" required style="width: 120px;">
            <button class="btn btn-info btn-sm" type="submit">Set</button>
          </form>

          <a href="{{ url_for('delete_product', product_id=product.id) }}"
             class="btn btn-danger btn-sm ms-1"
             onclick="return confirm('Delete {{ product.product_name }}?');">
            Delete
          </a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</body>
</html>